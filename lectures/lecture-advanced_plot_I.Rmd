---
title       : Data Analysis and Visualization in R
author      : Daniel Bader, Jun Cheng, Jan Krumsiek, Julien Gagneur
subtitle    : Plotting I
framework   : io2012
highlighter : highlight.js
hitheme     : tomorrow
widgets     : [mathjax, bootstrap, quiz]
ext_widgets : {rCharts: ["libraries/highcharts", "libraries/nvd3"]}
mode        : selfcontained # {standalone, draft}
knit        : slidify::knit2slides
---
<!-- Center image on slide -->
<script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.7.min.js"></script>
<script type='text/javascript'>
$(function() {
    $("p:has(img)").addClass('centered');
});
</script>
</script>
<script type = 'text/javascript'>
$('p:has(img.build)').addClass('build')
</script>

<script type='text/javascript'>
// parameters
var sections = ["Grammar of graphics", "1 continuous variable", "2 variables - one discrete, one continuous", "2 variables - both continuous", "Axes and labels"];
var title = "Overview";
var fontsize = "20pt"
var unselected_color = "#888888"
// function
function toc(cur) {
  // header
  document.write("<h2>"+title+"</h2>");
  // find current
  ind = sections.indexOf(cur);
  if (ind==-1 && cur.length>0) {
     document.write("<br/>Error: section not defined '"+cur+"'");
     return;
  }
  // write all out
  document.write("<br/><ul>");
  for (i = 0; i < sections.length; i++) { 
    if (cur=="") 
      // all the same
      document.write("<li style='font-size:"+fontsize+"'>"+sections[i]+"</li>");
    else {
      if (i==ind)
        document.write("<li style='font-size:"+fontsize+"'><b>"+sections[i]+"</b></li>");
      else
        document.write("<li style='color:"+unselected_color+";font-size:"+fontsize+"'>"+sections[i]+"</li>");
    }
  }
  document.write("</ul>");
}
</script>


```{r global_options, include=FALSE, cache=F}
# setwd(file.path(getwd(), 'lectures-WS1718'))
source("../config.R")
library(gridExtra)
opts_chunk$set(
    echo=TRUE, warning=FALSE, message=FALSE, cache=F, 
    results="show",
    out.width="500px", out.height="400px", fig.height = 3, fig.width = 4, 
    dpi=200
)
# options(width=100)
imgprefix <- 'assets/img/lec03_plotting/'
figprefix <- 'assets/fig/lec03_'

# data
poke_dt <- readRDS('extdata/tidy_pokemon_poke_dt.RDS')
moves_dt <- readRDS('extdata/tidy_pokemon_moves_dt.RDS')
olydt <- fread('extdata/summer_olympic_medals_ALL_MEDALISTS.csv')
ind <- fread('./extdata/CPI_HDI.csv')

mysize <- 15
mytheme <- theme(
    axis.title = element_text(size=mysize), 
    axis.text = element_text(size=mysize),
    legend.title = element_text(size=mysize),
    legend.text = element_text(size=mysize)
    ) + theme_bw()


options(knitr.package.unnamed.chunk.label="lecture-03")
```
---
<script type='text/javascript'>toc("1 continuous variable")</script>


---
## Define a theme
```{r}
mysize <- 15
mytheme <- theme(
    axis.title = element_text(size=mysize), 
    axis.text = element_text(size=mysize),
    legend.title = element_text(size=mysize),
    legend.text = element_text(size=mysize)
    ) + theme_bw()
```

This theme will be used accross the lecture. Details about how to change the theme of ggplot will be covered later in this course.

---
## Histogram
Histogram of Human Development Index (HDI) in the ind dataset: 
```{r}
ind
```

---
## Histogram
Histogram of Human Development Index (HDI) in the ind dataset: 
```{r lec03_hist1, warning=FALSE, out.width=c('600px', '500px'), message=FALSE}
ggplot(ind, aes(HDI)) +
  geom_histogram() + mytheme
```

---
## Histogram: setting the number of bins
Histogram of Human Development Index (HDI) in the ind dataset: 
```{r lec03_hist2, warning=FALSE, out.width='600cm', out.height='1200cm', message=FALSE}
ggplot(ind, aes(HDI)) +
  geom_histogram(bins=10) + mytheme
```


---
## Density plots
Sometimes denisties are shown instead of histograms.<br/><br/>
These smoothed distribution plot are typically obtained by kernel density estimation:<br/><br/>
[https://en.wikipedia.org/wiki/Kernel_density_estimation](https://en.wikipedia.org/wiki/Kernel_density_estimation)

Density plot of Human Development Index (HDI) in the ind dataset: 
```{r lec03_density1, warning=FALSE, out.width=c('400px', '400px'), message=FALSE}
ggplot(ind, aes(HDI)) +
  geom_density() + mytheme
```


---
## Kernel density plots - smoothing bandwidth

Can be set manually. Default option is a bandwidth rule (which is usually a good choice).

Small bandwidth:
```{r lec03_hist3, out.width=c('250px', '250px')}
ggplot(ind, aes(HDI)) +  geom_density(bw=0.01) + mytheme
```

Large bandwidth:
```{r lec03_density2,  out.width=c('250px', '250px')}
ggplot(ind, aes(HDI)) +  geom_density(bw=1) + mytheme
```

Be careful with density plots as the bandwdith can have strong visual effects. Histograms are not that bad and show the data 'raw'.

---

## What is a "boxplot"
<img src="./assets/img/lec06_Boxplot_vs_PDF.png" width="400">

from https://en.wikipedia.org/wiki/Box_plot<br/><br/>

* median = the center of the data, middle value in sorted list, 50% quantile of the data
* quartiles = 25% and 75% quantiles of the data
* lines outside the box are called "whiskers"
* whiskers reach to the most extreme datapoint within $\pm  1.5\cdot$IQR
* anything outside of the "whiskers" is plotted as an "outlier", see next slide

---

## What is a "boxplot"

```{r lec03_boxplot1,  echo=F, out.width='400px', out.height='800px', fig.height = 5, fig.width = 4}
set.seed(0)
xl <- c(0,5)
par(mfrow=c(1,2), mar=c(2,2,2,2)) 
dt <- data.table(x=rlnorm(1000,meanlog=0,sdlog=0.5), group='x')
p1 <- ggplot(dt, aes(x)) + geom_histogram(bins=30) + mytheme
p2 <- ggplot(dt, aes(group, x)) + geom_boxplot() + coord_flip() + mytheme
grid.arrange(p1, p2, ncol=1)
```

--- &radio

For which type of data will boxplots produce meaningful visualizations? (2 possible answers)

1. A. For discrete data.

2. B. For bi-modal distributions.

3. C. For non-Gaussian, symmetric data.

4. D. For exponentially distributed data.

***.explanation
See next slide

---


## Solution

**For which type of data will boxplots produce meaningful visualizations?**
* **C. For non-Gaussian, symmetric data.**
* **D. For exponentially distributed data.**

Boxplots are bad for bimodal data since they only show one mode (the median), but are ok for both symmetric and non-symmetric data, since the quartiles are not symmetric.
```{r lec03_boxplot2, fig.height = 2, fig.width = 4, fig.show='hold'}  
dt <- data.table(x=c(1,1,1,2,2,2,8,8,8), 
                 y=rbeta(n=1000,shape1=2,shape2=2),
                 z=rexp(n=1000, rate=1),
                 group='x') %>% melt(id.var="group")
ggplot(dt, aes(group, value)) + geom_boxplot() + facet_wrap(~variable) + mytheme
```

---

## Boxplots and multi-modal distributions

```{r echo=F}
set.seed(100)
```
```{r lec03_boxplot3,  out.width=c('400px', '400px'), fig.show='hold'}
x = c(rnorm(100,1), rnorm(100,1)+5)
hist(x)
boxplot(x)
```


Boxplot does not properly represent the distribution.


```{r, echo=F}
library(data.table)
library(ggplot2)
library(magrittr)
ind <- fread('./extdata/CPI_HDI.csv')
```

---

<script type='text/javascript'>toc("2 variables - one discrete, one continuous")</script>


---
## Boxplot by category

```{r lec03_boxplot4, out.width='600px', fig.height = 3, fig.width = 4.5}
ggplot(mpg, aes(class, hwy)) +
  geom_boxplot() + mytheme
```

---
## Violin plot

```{r lec03_boxplot5, out.width='600px', fig.height = 3, fig.width = 4.5}
ggplot(mpg, aes(class, hwy)) +
  geom_violin() + mytheme
```

---
## Beanplot
Using the package ggbeeswarm:

```{r lec03_beeswarm, out.width='600px', fig.height = 3, fig.width = 4.5}
# install.packages("ggbeeswarm")
library(ggbeeswarm)
ggplot(mpg, aes(class, hwy)) + 
  geom_beeswarm() + mytheme
```

---
## When to use a Barplot?

* bars are visual `heavyweights` compared to dots and lines 
* combining two attributes of 2-D location and 
  line length to encode quantitative values
* bars emphasize the individual values 
  of the thing being measured per categorical subdivision
* focus attention primarily on individual 
  values and support the comparison of one to another


--- &radio
## When to use a Barplot?

1. A To show a connection between a series of individual data points
2. B To show a correlation between two quantitative variables
3. C _To highlight individual quantitative values per category_
4. D To compare distributions of quantitative values across categories

---
## Visualize uncertainty

Visualizing uncertainty is important, otherwise barplots can be misleading. One way to visualize uncertainty is with error bars.

Standard deviation (SD) and standard error of the mean (SEM) as error bars. SD and SEM are different concepts. SD indicated the variation of quantity in the sample. SEM represents how well the mean is estimated. 

The central limit theorem implies that:
$\text{SEM} = \text{SD}/\sqrt{n}$ where $n$
is the sample size (number of observations).

With large $n$ , SEM tends to 0. 

---
## Barplots with error bars

Explain what this code does:
```{r lec03_erb, , out.width='500px', fig.height = 3, fig.width = 4.5}
as.data.table(mpg) %>% 
  .[, .(mean = mean(hwy),
        sd = sd(hwy)),
    by = class] %>% 
  ggplot(aes(class, mean, ymax=mean+sd, ymin=mean-sd)) + 
  geom_bar(stat='identity') +
  geom_errorbar(width = 0.3) + mytheme
```

---

<script type='text/javascript'>toc("2 variables - both continuous")</script>


---
## Scatterplot
```{r lec03_point1}
ggplot(mpg, aes(displ, hwy)) +
  geom_point() + mytheme
```

---
## Scatterplot with too many colors can be hard to read 
```{r lec03_point2, out.width='600px', fig.height = 3, fig.width = 5}
ggplot(mpg, aes(displ, hwy, color=class)) +
  geom_point() + mytheme
```

Too many colors, hard to distinguish. One can use `facet` to separate them into different plots.

---

## 2D density plots

Two-dimensional density plots can be obtained with kernel densities. We prefer to it  hexagon binning, which is the pendant of histograms for 2D data: 
```{r lec03_hex}
x <- rnorm(10000); y=x+rnorm(10000)
data.table(x, y) %>% ggplot(aes(x, y)) +
  geom_hex() + mytheme
```

---
## When to use a line plot?

Two main goals:
* To `connect` a series of individual data points
* To display the `trend` of a series of data points.

Why:
* showing the shape of data as it flows and changes from point to point. 
* strength: movement of values up and down through time
* it's often difficult to discern the overall trend of scatter plots, 
  but a simple trend line can bring it into sharp focus.

--- &radio
## When to use a line plot?

1. A _To show a connection between a series of individual data points_
2. B To show a correlation between two quantitative variables
3. C To highlight individual quantitative values per category
4. D To compare distributions of quantitative values across categories


---
## Line plot

```{r lec03_line}
ggplot(economics, aes(date, unemploy / pop)) +
  geom_line() + mytheme
```


---

<script type='text/javascript'>toc("Axes and labels")</script>



---
## Every aesthetic has a scale
ggplot automatically scales aesthetics, e.g. `x, y, colour, size, shape, fill...`. 

What happens to:
```{r lec03_point4, eval=FALSE}
ggplot(ind, aes(CPI, HDI)) +
  geom_point(aes(color=region)) + mytheme
```

is actually:
```{r lec03_point5, eval=FALSE}
ggplot(ind, aes(CPI, HDI)) +
  geom_point(aes(color=region)) +
  scale_x_continuous() +
  scale_y_continuous() + mytheme
```

You can **overwrite** them with `scale_*` commands.

---
## Overwrite scales, example:
* log scale
```{r lec03_point6, out.width='600px', fig.height = 3, fig.width = 5}
ggplot(ind, aes(CPI, HDI)) +
  geom_point(aes(color=region)) +
  scale_x_log10() + mytheme
```

---
## Overwrite scales, example:

```{r lec03_point7, out.width='600px', fig.height = 3, fig.width = 5}
ggplot(ind, aes(CPI, HDI)) +
  geom_point(aes(color=region)) +
  scale_x_continuous(trans = 'log10') + mytheme
```

But, where are my axis breaks? 

---
## Overwrite scales, example:
* Breaks and labels
```{r lec03_point8, out.width='600px', fig.height = 3, fig.width = 5}
ggplot(ind, aes(CPI, HDI)) +
  geom_point(aes(color=region)) +
  scale_x_log10(breaks=c(10, 20, 50, 100)) + mytheme
```

Same operations apply to y axis. 


---
## Change axis title
* Change labels
```{r lec03_point9, out.width='600px', fig.height = 3, fig.width = 5}
ggplot(ind, aes(CPI, HDI)) +
  geom_point(aes(color=region)) +
  scale_x_continuous('Engine CPIacement') +
  scale_y_continuous('Highway miles per gallon') + mytheme
```

---
## Change axis title
Changing label is a so frequent task that ggplot has several ways to do it:

```{r lec03_point10, out.width='500px', fig.height = 3, fig.width = 5}
ggplot(ind, aes(CPI, HDI)) +
  geom_point(aes(color=region)) +
  labs(x = 'Corruption Perceptions Index', 
       y = 'Human Development Index',
       title = 'Corruption vs Human Development',
       color = 'Which region') + mytheme
```

Try also with `xlabs`, `ylabs` and `ggtitle`.

---
## Change axis limits
```{r lec03_boxplot7, eval=FALSE}
df <- data.table(x = rep(c(1:2), each = 100),
                 y = c(rnorm(100, 20, 8), rnorm(100, 10, 7)))
ggplot(df, aes(x, y, group = x)) +
  geom_boxplot() + mytheme
# I want cut my y axis from 10 to 30.
ggplot(df, aes(x, y, group = x)) +
  geom_boxplot() +
  scale_y_continuous(limits = c(10, 30)) + mytheme
```

```{r lec03_boxplot8, eval=TRUE, echo=FALSE, out.width='500px', fig.height = 3, fig.width = 6}
df <- data.table(x = rep(c(1:2), each = 100),
                 y = c(rnorm(100, 20, 8), rnorm(100, 10, 7)))

p1 <- ggplot(df, aes(x, y, group = x)) +
  geom_boxplot() + mytheme

p2 <- ggplot(df, aes(x, y, group = x)) +
  geom_boxplot() +
  scale_y_continuous(limits = c(10, 30)) + mytheme
grid.arrange(p1, p2, ncol=2)
```

Note that the computed median changed! 

---
## When you use `limits` in `scale_`, ggplot will treat data points outside the range as `NA`.

* If you don't want this to happen, but simply "zoom in", use `coord_cartesian`. More details later. 

* Axis limits can also be changed with `xlim`, `ylim` as in base plots.
```{r lec03_boxplot9, out.width = "400px"}
ggplot(df, aes(x, y, group = x)) +
  geom_boxplot() +
  ylim(10, 30) + mytheme
```


---


## Conclusion
* You have thousands times thousands of pixels times thousands of colors.
* Show as much as the raw data as you can:
  * Extend boxplot and barplots with beeswarm plots
  * Combine density and individual data points in 1D or 2D.
  * Prefer histograms and hexagon 2D histograms over density estimations

---
# References

Web
* Main reference: [Udacity's Data Visualization and D3.js](https://www.udacity.com/courses/all)
* perceptual edge:
  * [the right graph](http://www.perceptualedge.com/articles/ie/the_right_graph.pdf)
  * [visual perception](http://www.perceptualedge.com/articles/ie/visual_perception.pdf)
  * [rules for color](http://www.perceptualedge.com/articles/visual_business_intelligence/rules_for_using_color.pdf)
  * [choosing color](http://www.perceptualedge.com/articles/b-eye/choosing_colors.pdf)
* flowingdata.com: [graphical perception](http://flowingdata.com/2010/03/20/graphical-perception-learn-the-fundamentals-first/)
* [Color Brewer](http://colorbrewer2.org/)

---
## Plotting libraries

- http://www.r-graph-gallery.com/portfolio/ggplot2-package/
- http://ggplot2.tidyverse.org/reference/
- https://plot.ly/r/
- https://plot.ly/ggplot2/

