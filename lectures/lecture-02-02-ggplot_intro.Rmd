---
title       : Simple Data Manipulation and Visualization
author      : Daniel Bader, Jun Cheng, Jan Krumsiek, Julien Gagneur
output:     pdf_document

subtitle    : Grammar of graphics and Plotting I
framework   : io2012
highlighter : highlight.js
hitheme     : tomorrow
widgets     : [mathjax, bootstrap, quiz]
ext_widgets : {rCharts: ["libraries/highcharts", "libraries/nvd3"]}
mode        : selfcontained # {standalone, draft}
knit        : slidify::knit2slides
---



<!-- Center image on slide -->
<script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.7.min.js"></script>
<script type='text/javascript'>
$(function() {
    $("p:has(img)").addClass('centered');
});
</script>
</script>
<script type = 'text/javascript'>
$('p:has(img.build)').addClass('build')
</script>

<script type='text/javascript'>
// parameters
var sections = ["Grammar of graphics", "1 continuous variable", "2 variables - one discrete, one continuous", "2 variables - both continuous", "Axes and labels"];
var title = "Overview";
var fontsize = "20pt"
var unselected_color = "#888888"
// function
function toc(cur) {
  // header
  document.write("<h2>"+title+"</h2>");
  // find current
  ind = sections.indexOf(cur);
  if (ind==-1 && cur.length>0) {
     document.write("<br/>Error: section not defined '"+cur+"'");
     return;
  }
  // write all out
  document.write("<br/><ul>");
  for (i = 0; i < sections.length; i++) { 
    if (cur=="") 
      // all the same
      document.write("<li style='font-size:"+fontsize+"'>"+sections[i]+"</li>");
    else {
      if (i==ind)
        document.write("<li style='font-size:"+fontsize+"'><b>"+sections[i]+"</b></li>");
      else
        document.write("<li style='color:"+unselected_color+";font-size:"+fontsize+"'>"+sections[i]+"</li>");
    }
  }
  document.write("</ul>");
}
</script>

````{r global_options, include=FALSE, cache=F}
# setwd(file.path(getwd(), 'lectures-WS1718'))
source("../config.R")
library(gridExtra)
opts_chunk$set(
    echo=TRUE, warning=FALSE, message=FALSE, cache=F, 
    results="show",
    out.width="500px", out.height="400px", fig.height = 3, fig.width = 4, 
    dpi=200
)
# options(width=100)
imgprefix <- 'assets/img/lec02/'
figprefix <- 'assets/fig/lec02_'

# data
ind <- fread('./extdata/CPI_HDI.csv')

mysize <- 15
mytheme <- theme(
    axis.title = element_text(size=mysize), 
    axis.text = element_text(size=mysize),
    legend.title = element_text(size=mysize),
    legend.text = element_text(size=mysize)
    ) + theme_bw()


options(knitr.package.unnamed.chunk.label="lecture-02")
```


---

## Why plotting?

Data in scientific publications is shown as plots, sure. But there is more.

**A realistic example to warm up**:

A vector containing (hypothetical) height measurements for adults in Germany:

```{r echo=F}
set.seed(0)
height <- c(rnorm(499, mean=1.65, sd=0.045), 165)
```

```{r, echo=TRUE}
length(height)
head(height, n=20)
```

Calculating the mean height:

```{r, echo=TRUE}
mean(height)
```
Wait... what?


--- &radio
```{r}
mean(height)
```
<br/>

What happened?

1. A. `mean()` is not the right function to assess what we want to know.

2. B. Adults in Germany are exceptionally tall

3. C. _A decimal point error in one data point._

4. D. It's a multiple testing problem because we are looking at so many data points (n=500).

***.explanation
See next slide

---

## Solution
```{r, echo=TRUE}
mean(height)
```

**What happened?**<br/>

* A. `mean()` is not the right function to assess what we want to know.
  * *No, the mean is exactly what we want.*
* B. Adults in Germany are exceptionally tall.
  * *OK, no...*
* **C. A decimal point error in one data point.**
  * *Yes, see next slide.*
* D. It's a multiple testing problem because we are looking at so many data points (n=500).
  * *This question was intentionally misleading, this does not have anything to do with multiple testing.*



---


## The outlier...

```{r out.width=c('300px', '300px'), fig.show='hold'}
plot(height)
hist(height)
```

```{r, echo=TRUE}
mean(height)
```

---


## The outlier...

Getting rid of the outlier fixes the dataset

```{r, echo=TRUE}
fheight <- height[height < 3]
```

```{r out.width=c('300px', '300px'), fig.show='hold'}
plot(fheight)
hist(fheight)
```

```{r, echo=TRUE}
mean(fheight)
```

---

## The outlier...

This is how the broken dataset was generated:

```{r, echo=TRUE}
height <- c(rnorm(499, mean=1.65, sd=0.045), 165)
```

---

<script type='text/javascript'>toc("")</script>

---

<script type='text/javascript'>toc("Grammar of graphics")</script>

---
## Grammar of Graphics
The Grammar of Graphics is a visualization theory developed by 
Leland Wilkinson in 1999.
<br> 

* influenced the development of graphics and visualization libraries alike 
* 3 key principles
  * Separation of data from aesthetics (e.g. x and y axis, color-coding)
  * Definition of common plot/chart elements (e.g. dot plots, boxplots, etc.)
  * Composition of these common elements (one can combine elements as layers)


---
## ggplot2 and Grammar of Graphics
```{r lec02_plt1, out.width='700px', fig.width=6, fig.height=3}
ggplot(mpg, aes(x=displ, y=cty, colour=class)) +  # Data: how variables in the data are mapped to aesthetic attributes 
  geom_point() +  # Layers: made up of geometric elements and statistical transformation.
  facet_wrap(~ class, ncol=4) + # Facets
  theme(axis.title = element_text(size=15), legend.title = element_text(size=15)) +
  labs(title='displ vs cty', x='Engine displacement', y='city miles per gallon') +
  stat_smooth() # Stats
```


---
## Grammar Defines Components of Graphics
**Data:** data.frame (or data.table) object where columns correspond to variables

**Aesthetics:** describes visual characteristics that represent data (`aes`)
 - for example: position, size, color, shape, transparency, fill

**Layers:** made up of geometric objects that represent data (`geom_`)
 - for example: points, lines, polygons, ...

**Scales:** for each aesthetic, describes how visual characteristic is converted to display values (`scale_`)
 - for example: log scales, color scales, size scales, shape scales, ...

**Facets:** describes how data is split into subsets and displayed as multiple sub graphs (`facet_`)

**Stats:** statistical transformations that typically summarize data (`stat`)
 - for example: counts, means, medians, regression lines, ...
 
**Coordinate system:** describes 2D space that data is projected onto (`coord_`)
 - for example: Cartesian coordinates, polar coordinates, map projections, ...

---

## Simple example: Human Development versus Corruption Perception
```{r}
ind <- fread('../extdata/CPI_HDI.csv')
ind
```

<br>
CPI: Corruption Perceptions Index (http://www.transparency.org/)
HDI: Human Development Index (http://hdr.undp.org/)
Year: 2014
<br>
---

## Simple example: Human Development versus Corruption Perception
```{r lec02_plt2, out.width='500px', fig.width=3, fig.height=2.5}
ggplot(ind, aes(CPI, HDI)) + geom_point()
```

<br>
CPI: Corruption Perceptions Index (http://www.transparency.org/)
HDI: Human Development Index (http://hdr.undp.org/)
Year: 2014
<br>
---

---
## Simple scatter plot
```{r lec02_plt3, out.width='500px', fig.width=3, fig.height=2}
ggplot(ind, aes(CPI, HDI)) + 
  geom_point()
```

---
## ggplot returns an object
```{r lec02_plt7, out.width='500px', fig.width=3, fig.height=2.5}
p <- ggplot(ind, aes(CPI, HDI)) + geom_point()
p
```

---
## ggplot returns an object
```{r lec02_plt8, out.width='400px', fig.width=3, fig.height=2.5}
names(p)
saveRDS(p, "../extdata/lec06_p.rds")
p <- readRDS("../extdata/lec06_p.rds")
p + geom_hline(yintercept = 0.7)
```

---
## Mapping of aesthetics can be done globally at `ggplot()` or at individual layers
```{r lec02_plt4, out.width='500px', fig.width=3, fig.height=2.5}
ggplot(ind, aes(CPI, HDI)) + 
  geom_point(size=0.5) + 
  geom_text(aes(label = wbcode), size=2, vjust=0)
```

---
## Mapping of aesthetics can be done globally at `ggplot()` or at individual layers
```{r lec02_plt12, out.width='500px', fig.width=3, fig.height=2}
ggplot(ind) + 
  geom_point(aes(CPI, HDI))
```

Global mapping is inherited by default to all geom layers, while `aes` mapping at individual layer is only recognized at that layer.

---
## Mapping of aesthetics done at individual layers
```{r lec02_plt5, out.width='500px', fig.width=3, fig.height=2.5}
ggplot(ind) + 
  geom_point(aes(CPI, HDI), size=0.5) + 
  geom_text(aes(CPI, HDI, label = wbcode), size=2, vjust=0)
```

---
## Individual layer mapping cannot be recognized by other layers
```{r lec02_plt6, out.width='500px', fig.width=3, fig.height=2.5}
ggplot(ind) + 
  geom_point(aes(CPI, HDI)) + 
  geom_text(aes(label = wbcode))
```

---
## You can easily map variables to different colours, sizes or shapes!
ggplot2 automatically scales for you.
```{r lec02_plt9, out.width='600px', fig.width=6, fig.height=3}
ggplot(data = ind) + 
  geom_point(aes(CPI, HDI, color = region))
```

American `color` or British `colour` both acceptable.


---
## You can easily map variables to different colours, sizes or shapes!

```{r lec02_plt10, out.width='600px', fig.width=6, fig.height=3}
ggplot(data = ind) + 
  geom_point(aes(CPI, HDI, shape = region))
```

---
## Aesthetic mappings can also be supplied in individual layers
```{r lec02_plt11, out.width='600px', fig.width=6, fig.height=3}
ggplot(ind, aes(CPI, HDI)) + 
  geom_point(aes(color = region))
```

--- &radio

What's the result of the following command?

`ggplot(data = mpg)`

1. A Nothing happens

2. B _A blank figure will be produced_

3. C A blank figure with axis will be produced

4. D All data in `mpg` will be visualized

***.hint
ggplot builds plot layer by layer. 

***.explanation
Neither variables were mapped nor geometry specified. 


--- &radio

What's the result of the following command?

`ggplot(data = mpg, aes(x = hwy, y = cty))`

1. A Nothing happens

2. B A blank figure will be produced

3. C _A blank figure with axis will be produced_

4. D A scatter plot will be produced

***.hint
ggplot builds plot layer by layer. 

***.explanation
Axis x and y are mapped. But no geometry specified.


--- &radio

What's the result of the following command?

`ggplot(data = mpg, aes(x = hwy, y = cty)) + geom_point()`

1. A Nothing happens

2. B A blank figure will be produced

3. C A blank figure with axis will be produced

4. D _A scatter plot will be produced_

***.hint
ggplot builds plot layer by layer. 

***.explanation
Axis x and y are mapped. But no geometry specified.


---

## Take-home
* Visualization is as important as statistics. Both are needed.
* Visualization can help finding "bugs" in the data
* Grammar of graphics separates data, aesthetics, and geometries
* more to come next week ...



---
## Plotting libraries

- http://www.r-graph-gallery.com/portfolio/ggplot2-package/
- http://ggplot2.tidyverse.org/reference/
- https://plot.ly/r/
- https://plot.ly/ggplot2/





