---
title       : Data Analysis and Visualization in R
author      : Jun Cheng, Daniel Bader, Jan Krumsiek, Vicente Yepez, Julien Gagneur
subtitle    : Plotting II
framework   : io2012
highlighter : highlight.js
hitheme     : tomorrow
widgets     : [mathjax, bootstrap, quiz]
ext_widgets : {rCharts: ["libraries/highcharts", "libraries/nvd3"]}
mode        : selfcontained # {standalone, draft}
knit        : slidify::knit2slides
---

<!-- Center image on slide -->
<script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.7.min.js"></script>
<script type='text/javascript'>
$(function() {
    $("p:has(img)").addClass('centered');
});
</script>
</script>
<script type = 'text/javascript'>
$('p:has(img.build)').addClass('build')
</script>

<script type='text/javascript'>
// parameters
var sections = ["Multidimensional Data", "Conditioning", "Colors", "Themes & Elements", "Interactive Plots", "Bad Habits"];
var title = "Overview";
var fontsize = "20pt"
var unselected_color = "#888888"
// function
function toc(cur) {
  // header
  document.write("<h2>"+title+"</h2>");
  // find current
  ind = sections.indexOf(cur);
  if (ind==-1 && cur.length>0) {
     document.write("<br/>Error: section not defined '"+cur+"'");
     return;
  }
  // write all out
  document.write("<br/><ul>");
  for (i = 0; i < sections.length; i++) { 
    if (cur=="") 
      // all the same
      document.write("<li style='font-size:"+fontsize+"'>"+sections[i]+"</li>");
    else {
      if (i==ind)
        document.write("<li style='font-size:"+fontsize+"'><b>"+sections[i]+"</b></li>");
      else
        document.write("<li style='color:"+unselected_color+";font-size:"+fontsize+"'>"+sections[i]+"</li>");
    }
  }
  document.write("</ul>");
}
</script>


```{r global_options, include=FALSE, cache=F}
# setwd(file.path(getwd(), 'lectures-WS1718'))
source("../config.R")
opts_chunk$set(
    echo=TRUE, warning=FALSE, message=FALSE, cache=F, 
    results="show",
    out.width="500px", out.height="400px", fig.height = 3, fig.width = 4, 
    dpi=200
)
# options(width=100)
imgprefix <- 'assets/img/lec06_07_plotting/'
figprefix <- 'assets/fig/lec04_'

# data
poke_dt <- readRDS('extdata/tidy_pokemon_poke_dt.RDS')
moves_dt <- readRDS('extdata/tidy_pokemon_moves_dt.RDS')
olydt <- fread('extdata/summer_olympic_medals_ALL_MEDALISTS.csv')
ind <- fread('./extdata/CPI_HDI.csv')

mysize <- 15
mytheme <- theme(
    axis.title = element_text(size=mysize), 
    axis.text = element_text(size=mysize),
    legend.title = element_text(size=mysize),
    legend.text = element_text(size=mysize)
    ) + theme_bw()


options(knitr.package.unnamed.chunk.label="lecture-07")
```


---
<script type='text/javascript'>toc("Multidimensional Data")</script>

---
## Multidimensional data

* For this part, we assume all variables to be quantitative.

* That means, all variable values will be plotted on continuous (xy-)axes.

* More complicated, mixed binary/multinomial/ordinal/continuous data might require specialized plotting and data analysis strategies.

---

## Small dimensionality, ~3-10 variables

**Plot matrix**

```{r lec04_ggpairs, fig.width=6.5, fig.height=6.5, out.width="450px"}
library(GGally)
ggpairs(mpg, columns = c("displ","cyl","cty","hwy")) + mytheme
```

---

## Medium dimensionality, <100 variables

Correlation plots, "corrgrams", "correlograms"

```{r lec04_corplot}
GGally::ggcorr(mtcars, geom = 'circle') 
```

---

## High dimensionality, >100, >>100 variables

Heatmaps

```{r lec04_heatmap,  fig.height=4, fig.width=7, out.width="700px"}
mtcars_melted <- as.data.table(scale(mtcars[1:10,]), keep.rownames = "Cars") %>% melt(id.var = "Cars")
mtcars_melted <- mtcars_melted
ggplot(mtcars_melted, aes(variable, Cars)) +
  geom_tile(aes(fill=value)) +
   scale_fill_gradient2(low='darkblue', mid= 'white', high='darkred') + mytheme
```


---

## Conditional correlation
In this data, the two variables Phenotype and Expression are nicely correlated:

```{r lec04_cond, echo=F,warning=F}
library(data.table)
library(ggplot2)
AA <- data.table(Expression = rnorm(1000, mean = 5), 
                 Phenotype = rnorm(1000, mean=1, sd = 1.5))
AB <- data.table(Expression = rnorm(2000, mean = 6), 
                 Phenotype = rnorm(2000, mean=4, sd = 1.5))
BB <- data.table(Expression = rnorm(1000, mean = 8), 
                 Phenotype = rnorm(1000, mean=8, sd = 1.5))
dt <- rbindlist(list(AA=AA, AB=AB, BB=BB), idcol = "Genotype")
# shuffle, so head shows different genotypes
dt <- dt[sample(dim(dt)[1],dim(dt)[1]),]
```


```{r lec04_scat}
ggplot(dt, aes(Phenotype, Expression)) + geom_point() + mytheme
dt[, cor(Phenotype, Expression)]
```

&nbsp;...but are they directly correlated or is that due to a further variable?


---

## Facets are good to check conditional correlation

```{r lec04_scat_cond2, echo=T, out.width='600px', fig.height = 3, fig.width = 4.5}
ggplot(dt, aes(Phenotype, Expression)) + geom_point() + facet_wrap(~ Genotype) + mytheme
```

**Statistically speaking**: The two variables *are* correlated, but their conditional correlation (given the genotype) is zero.



---
## The `diamonds` data
```{r, echo=FALSE}
head(diamonds, 1)
```
Description of R datasets are available through the help.

```{r}
?diamonds
```
Variable  | Description
------------- | -------------
price  | price in US dollars (\$326???\$18,823)
carat  | weight of the diamond (0.2???5.01)
cut | quality of the cut (Fair, Good, Very Good, Premium, Ideal)
color | diamond colour, from J (worst) to D (best)
clarity | a measurement of how clear the diamond is (I1 (worst), SI1, SI2, VS1, VS2, VVS1, VVS2, IF (best))
x | length in mm (0???10.74)
y | width in mm (0???58.9)
z | depth in mm (0???31.8)
depth | total depth percentage = z / mean(x, y) = 2 * z / (x + y) (43???79)
table | width of top of diamond relative to widest point (43???95)

---
## Conditioning with categorial variables: multi-way histograms
We introduced that, one can map variables to colours easily with ggplot.
```{r, lec04_pos1, fig.height=4, fig.width=7, out.width="600px"}
ggplot(data = diamonds, aes(cut, fill = cut)) + 
  geom_bar() + mytheme
```

What happens if you map fill colour to other variable like `clarity`? 

---
## Conditioning with categorial variables: multi-way histograms
```{r, lec04_pos2, fig.height=4, fig.width=7, out.width="600px"}
ggplot(diamonds, aes(x = cut, fill = clarity)) + 
  geom_bar() + mytheme
```

The stacking is performed automatically by the position adjustment specified by the position argument. The default position is "`stack`". 

---
## Conditioning with categorial variables: multi-way histograms
* fill
```{r, lec04_pos3, fig.height=4, fig.width=7, out.width="600px"}
ggplot(diamonds, aes(x = cut, fill = clarity)) + 
  geom_bar(position = "fill") + mytheme
```

`position = "fill"` works like stacking, but makes each set of stacked bars the have same height. This makes it easier to compare proportions across groups.


---
## Conditioning with categorial variables: multi-way histograms
* dodge
```{r, lec04_pos4, fig.height=4, fig.width=7, out.width="600px"}
ggplot(diamonds, aes(x = cut, fill = clarity)) + 
  geom_bar(position = "dodge") + mytheme
```

`position = "dodge"` places overlapping objects directly beside one another. This makes it easier to compare individual values.

Other position types include `"jitter"` and `"identity"`.


---

<script type='text/javascript'>toc("Colors")</script>

---

## Color coding in R

Four ways to code colors in R (ggplot2):<br/><br/>

1. Default aesthetic mapping (`aes(color = variable)`)

```{r, eval=F}
x <- c(1:5); dt <- data.table(x)
p <- ggplot(dt, aes(x)) # save the mapping to p
p + geom_bar(aes(fill = factor(x))) # factor convert x into factors, then map to ggplot default color palette
p + geom_bar(aes(fill = factor(x))) + scale_fill_brewer(palette="Spectral") # change default color palette
```

```{r, lec04_cor1, eval=T, echo=F, fig.width=8, fig.height=4, out.width="600px"}
library(gridExtra)
x <- c(1:5); dt <- data.table(x)
p <- ggplot(dt, aes(x)) # save the mapping to p
p1 <- p + geom_bar(aes(fill = factor(x))) + mytheme
p2 <- p + geom_bar(aes(fill = factor(x))) + scale_fill_brewer(palette="Spectral") + mytheme
grid.arrange(p1, p2, ncol=2)
```

---

## Color coding in R

Four ways to code colors in R (ggplot2):<br/><br/>

1. Default aesthetic mapping (`aes(color = variable)`)
2. Predefined color numbers 

```{r, lec04_cor1.2, fig.width=4, out.width="400px"}
x <- c(1:5); dt <- data.table(x)
p <- ggplot(dt, aes(x)) # save the mapping to p
p + geom_bar(fill = x) + mytheme
```

---

## Color coding in R

Four ways to code colors in R (ggplot2):<br/><br/>

1. Default aesthetic mapping (`aes(color = variable)`)
2. Predefined color numbers 
3. Predefined color names, as listed in `colors()` 

```{r, lec04_cor1.3, fig.width=4, out.width="400px"}
x <- c(1:5); dt <- data.table(x)
p <- ggplot(dt, aes(x)) # save the mapping to p
p + geom_bar(fill=c("green", "red", "blue", "gray","palevioletred3")) + mytheme
head(colors(), n = 5)
```

---

## Color coding in R

Four ways to code colors in R (ggplot2):<br/><br/>

1. Default aesthetic mapping (`aes(color = variable)`)
2. Predefined color numbers 
3. Predefined color names
4. RGB - HTML color codes

* *Additive color model*
* Hexadecimal coding of three number pairs for red, green, blue; and alpha (00%-99%) for transparency
* `00`-`FF` corresponds to 0-255

<!-- <img src="assets/img/lecture-06-additivecolors-wiki.jpg" width="420">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -->
<!-- <img src="assets/img/lecture-06-colorwheel.jpg" width="420"> -->

<!-- http://en.wikipedia.org/wiki/Additive_color -->

<!-- http://urlnextdoor.com/iadt/web-design_1/week04.php -->


---

## Color coding in R

Four ways to code colors in R (ggplot2):<br/><br/>

1. Default aesthetic mapping (`aes(color = variable)`)
2. Predefined color numbers 
3. Predefined color names
4. RGB - HTML color codes (last bar with 50% transparency)

```{r, lec04_cor1.4, fig.width=3.5, fig.height=3, out.width="300px"}
x <- c(1:5); dt <- data.table(x)
p <- ggplot(dt, aes(x)) # save the mapping to p
p + geom_bar(fill=c("#FFFFFF", "#FFFF00", "#666666","#22AAAA", "#00008050")) + mytheme
```

---
## RColorBrewer 
The RColorBrewer package provides a set of nice color palettes
```{r, RColorBrewer, fig.width=15, fig.height=10, out.width="800px"}
display.brewer.all()
```


---
## Careful with colors
### Color in context

* Like all aspects of visual perception, we do not perceive color in an absolute manner. 

* Perception of an object is influenced by the context

* Visual perception is relative, not absolute.

```{r, out.width = "500px", echo=F}
knitr::include_graphics("assets/img/lec07_col_contrast.png")
```


---
## Careful with colors
### Color in context

**Rule #1**

If you want different objects of the `same color` in a table or graph to look the same, 
make sure that the `background is consistent`.

**Rule #2**

If you want objects in a table or graph to be `easily seen`, 
use a background color that `contrasts sufficiently` with the object.


---
## Careful with colors
### Use color meaningfully and with restraint
(This is an example of double-encoding (position and colors))

```{r, warning=F, results='hide', echo=F}
dt <- poke_dt[,.(mean_hp = mean(HP, na.rm=T)), by=Type][order(mean_hp)]
dt[,Type:= factor(Type, levels = as.character(Type))]
p <- plot_ly(dt, y= ~mean_hp, x= ~Type, type='bar', 
             color=~Type, colors= rainbow(length(unique(dt$Type)))) %>%
  layout( xaxis=list(categoryorder='trace', title=''),
         yaxis=list(title='Average health power'),
         title='Pokemon health power by type',
         margin=list(b=60)
  )
# p
tmpf12 <- "assets/fig/lec07-col_restraint.html"
save_plotly_as_widget(p, file.path(getwd(),tmpf12))
```
`r print_plotly_iframe(tmpf12)`

---
## Careful with colors
### Use color meaningfully and with restraint

**Rule #3**

Use color only when needed to serve a particular communication goal.

**Rule #4** 

Use different colors only when they correspond to differences of meaning in the data.

**Rule #5**

Use `soft`, natural colors to display `most` information 
and `bright` and/or dark colors to `highlight` information that requires greater attention.

---
## Careful with colors
### Define standard palettes of colors for particular purposes

Different types of color palettes
* Categorical: separate items into distinct groups
* Sequential: quantitative differences. Typically for quantitative positive values.
```{r, out.width = "500px", echo=F}
knitr::include_graphics("assets/img/lec07_col_seq_pal.png")
```

* Diverging: quantitative differences, breakpoint. For quantitative signed values (e.g. correlations)

```{r, out.width = "500px", echo=F}
knitr::include_graphics("assets/img/lec07_col_div_pal.png")
```

---
## What's wrong with the following plot?

```{r, out.width = "400px", echo=F}
knitr::include_graphics("assets/img/lec07-bad1.png")
```

Xiong et al., Science 2014

---
## What's wrong with the following plot?

```{r, out.width = "400px", echo=F}
knitr::include_graphics("assets/img/lec07-bad1.png")
```

1. Rainbow color where there are no breakpoints. Color boundaries are created based on author's interest.

2. Manually twisted color scale.

---

<script type='text/javascript'>toc("Themes & Elements")</script>

---
## Themes control non-data parts of your plots:
* Complete theme
* Axis title
* Axis text
* Plot title
* Legends

They control the appearance of your plots: size, color, position... 

But have nothing to do with how the data is represented.

---
## Complete themes
```{r, lec04_theme_bw, out.width='600px', fig.height = 3, fig.width = 5}
ggplot(ind, aes(CPI, HDI, color=region)) +
  geom_point() +
  theme_bw() # black and white
```

Other complete themes: `theme_classic`, `theme_minimal`, `theme_light`, `theme_dark`.

---
## More themes with `ggthemes` package (from github)
```{r, lec04_theme_ggtheme, out.width='480px', fig.height = 3, fig.width = 4}
library(ggthemes)
ggplot(ind, aes(CPI, HDI, color=region)) +
  geom_point() +
  theme_wsj() + scale_colour_wsj("colors6", "")
```

wsj: Wall Street Journal

---
## Axis title
`axis.title`

`axis.title.x`

`axis.title.y`

In case of many themes, the latter overrides the former

```{r, lec04_theme_axis2, out.width='600px', fig.height = 3, fig.width = 5}
ggplot(ind, aes(CPI, HDI, color=region)) +
  geom_jitter() + theme_bw() +
  theme(axis.title = element_text(size=20, color = 'red')) 
```


---
## Axis text
`axis.text`

`axis.text.x`

`axis.text.y`

```{r, lec04_theme_axis3, out.width='600px', fig.height = 3, fig.width = 5}
ggplot(ind, aes(CPI, HDI, color=region)) +
  geom_jitter() + theme_bw() +
  theme(axis.text = element_text(size=20, color = 'blue')) 
```

---
## Summary axis elements
The axis elements control the apperance of the axes:

Element             | Setter            | Description               
--------------------|-------------------|---------------------------
axis.line           | `element_line()`  | line parallel to axis (hidden in default themes)
axis.text           | `element_text()`  | tick labels               
axis.text.x         | `element_text()`  | x-axis tick labels        
axis.text.y         | `element_text()`  | y-axis tick labels        
axis.title          | `element_text()`  | axis titles               
axis.title.x        | `element_text()`  | x-axis title              
axis.title.y        | `element_text()`  | y-axis title              
axis.ticks          | `element_line()`  | axis tick marks           
axis.ticks.length   | `unit()`          | length of tick marks 


---
## Plot title themes
```{r, lec04_theme_axis4, out.width='650px', fig.height = 3, fig.width = 5}
ggplot(ind, aes(CPI, HDI, color=region)) +
  geom_jitter() +
  ggtitle('CPI vs HDI') + theme_bw() +
  theme(plot.title = element_text(size=20, face = 'bold')) 
```

---
## Plot title themes
Some elements affect the plot as a whole:

Element               | Setter           | Description               
----------------------|------------------|------------
plot.background       | `element_rect()` | plot background
plot.title            | `element_text()` | plot title
plot.margin           | `margin()`       | margins around plot


---
## Legend themes
```{r, lec04_theme_axis, out.width='600px', fig.height = 3, fig.width = 5}
base <- ggplot(ind, aes(CPI, HDI, color=region)) +
  geom_jitter() + theme_bw()
base + theme(
  legend.text = element_text(size = 15),
  legend.title = element_text(size = 15, face = "bold")
)
```

---
The legend elements control the appearance of all legends. You can also modify the appearance of individual legends by modifying the same elements in `guide_legend()` or `guide_colourbar()`.

Element             | Setter                    | Description                                 |
--------------------|---------------------------|---------------------------------------------|
legend.background   |  `element_rect()`         | legend background                           |
legend.key          |  `element_rect()`         | background of legend keys                   |
legend.key.size     |  `unit()`                 | legend key size                             |
legend.key.height   |  `unit()`                 | legend key height                           |
legend.key.width    |  `unit()`                 | legend key width                            |
legend.margin       |  `unit()`                 | legend margin                               |
legend.text         |  `element_text()`         | legend labels                               |
legend.text.align   |  0--1                     | legend label alignment (0 = right, 1 = left)|
legend.title        |  `element_text()`         | legend name                                 |
legend.title.align  |  0--1                     | legend name alignment (0 = right, 1 = left) |


---

<script type='text/javascript'>toc("Interactive Plots")</script>


---
## Interactive plots with plotly

```{r, echo=F, out.width='400px', fig.height = 2, fig.width = 4}
p <- ggplot(mtcars, aes(factor(cyl), mpg)) + 
  geom_boxplot()
p <- ggplotly(p)
tmpf1 <-  "assets/fig/lec07-boxplot.html"
save_plotly_as_widget(p, file.path(getwd(), tmpf1))
```

```{r, eval=F, out.width='400px', fig.height = 2, fig.width = 4}
library(plotly)
p <- ggplot(mtcars, aes(factor(cyl), mpg)) + 
  geom_boxplot()
ggplotly(p)
```
`r print_plotly_iframe(tmpf1, height="10%", width="150px")`


---

<script type='text/javascript'>toc("Bad Habits")</script>

---
## Chart junk

[Source: Darkhorse Analytics](http://www.darkhorseanalytics.com/blog/data-looks-better-naked/)


<img src="./assets/img/lec05-data-ink.gif" width="600">


---
## Chart junk

* poor **data-ink ratio**
* double encoding (color and axis encode the same)
* heavy or dark grid lines
* unnecessary text
* ornamented chart axes
* pictures within graphs
* shading, color gradients or 3D perspective


--- &radio
## Question
Which item is *not* chart junk?

1. A a bright red plot border

2. B _light grey major grid lines_

3. C bold labels and yellow grid lines

4. D data labels in Batik Gangster font

***.hint

Bright colors and bold text draw attention. This font really exists. Grid lines are no data points.

***.explanation

Light grey does not draw attention and grid lines are less important than data.


---
## Assembling paper figures
`cowplot` package is a simple add-on to ggplot2. It provides publication-ready theme for ggplot2.

```{r, lec04_cawplot, out.width='800px', fig.height = 4, fig.width = 10}
library(cowplot)
plot_mpg <- ggplot(mpg, aes(x = cty, y = hwy, colour = factor(cyl))) + 
  geom_point(size=2.5)
plot_diamonds <- ggplot(diamonds, aes(clarity, fill = cut)) + geom_bar() +
  theme(axis.text.x = element_text(angle=70, vjust=0.5))
plot_grid(plot_mpg, plot_diamonds, labels = c("A", "B")) # can modify ncol or nrow
```

---
## Reproducible data analysis with Snakemake
Basic idea:
* Decompose workflow into "rules" (steps).
* Rules define how to obtain output files from input files.
* Snakemake infers dependencies and execution order with a Directed Acyclic Graph.
* Any change in the input, only affected downstream rules will be excuted.
* Disjoint paths in the DAG of jobs can be executed in parallel.
* Re-run all workflows with single `snakemake` command.

---
## Example
```{}
rule sort:
    input:
        "path/to/dataset.txt"
    output:
        "dataset.sorted.txt"
    shell:
        "sort {input} > {output}"
```

---
## Example

```{}
rule sort:
    input:
        a="path/to/{dataset}.txt"
    output:
        b="{dataset}.sorted.txt"
    run:
        with open(output.b, "w") as out:
            for l in sorted(open(input.a)):
                print(l, file=out)
```

---
## Example
```{}
DATASETS = ["D1", "D2", "D3"] # use native python code

rule all:
    input:
        expand("{dataset}.sorted.txt", dataset=DATASETS)

rule sort:
    input:
        "path/to/{dataset}.txt"
    output:
        "{dataset}.sorted.txt"
    shell:
        "sort {input} > {output}"
```

---
## For next class
### Make a 6-slides presentation showing:

1.What is the Problem?

2.The tidy version of your dataset. Each row should correspond to one observation.

3 - 5: 3 Figures. The title of each should be the take-home message (eg. "The drug significantly represses bacterial growth"), instead of just a description of the plot (eg. "Scatter plot before and after treatment").

6.Conclusion

### Submit on Moodle:
1.Slides

2.Raw Data

3.Rmarkdown script that takes as input the data and generates all figures


---
## References

* These slides are mostly based on Hadley Wickham's book [ggplot2: elegant graphics for data analysis](https://github.com/hadley/ggplot2-book)

* [**Everything else** from Hadley Wickham](http://hadley.nz/)

* In-depth documentations:

  * [ggplot2 cheatsheet](https://www.rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.pdf)
  * [Introduction to ggplot2](https://opr.princeton.edu/workshops/Downloads/2015Jan_ggplot2Koffman.pdf)
  * [plotly for R](https://cpsievert.github.io/plotly_book/)
